.\" Automatically generated by Pod::Man 2.27 (Pod::Simple 3.28)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is turned on, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{
.    if \nF \{
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\"
.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
.    \" fudge factors for nroff and troff
.if n \{\
.    ds #H 0
.    ds #V .8m
.    ds #F .3m
.    ds #[ \f1
.    ds #] \fP
.\}
.if t \{\
.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.    ds #V .6m
.    ds #F 0
.    ds #[ \&
.    ds #] \&
.\}
.    \" simple accents for nroff and troff
.if n \{\
.    ds ' \&
.    ds ` \&
.    ds ^ \&
.    ds , \&
.    ds ~ ~
.    ds /
.\}
.if t \{\
.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.\}
.    \" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.    \" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.    \" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.    ds : e
.    ds 8 ss
.    ds o a
.    ds d- d\h'-1'\(ga
.    ds D- D\h'-1'\(hy
.    ds th \o'bp'
.    ds Th \o'LP'
.    ds ae ae
.    ds Ae AE
.\}
.rm #[ #] #H #V #F C
.\" ========================================================================
.\"
.IX Title "DBBACKUP 1"
.TH DBBACKUP 1 "2014-06-16" "perl v5.18.2" "User Contributed Perl Documentation"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
dbbackup \- a simple script to make backups of databases.
.SH "SYNOPSIS (Version 1.0)"
.IX Header "SYNOPSIS (Version 1.0)"
.Vb 1
\&        dbbackup [choice]
.Ve
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
\&\fBdbbackup\fR is a simple script to backup databases. It relies on database tools such as \fBpg_dump\fR and \fBmysql\fR to do the backups.  This version (1.0) works with postgresql and mysql databases.
.PP
Dumps are made to an intermediate location \fIX.inprogress\fR and moved to the final location \fIX.completed\fR on successfull completion.  Mysql dumps are to file; postgres dumps use the more flexible directory format.
.PP
A configuration file dbbackup.conf is required.  It is searched for in /etc, the script directory and the users home directory. This can be redefined at the top of the script as necessary. The format of this file is given below.  Each section of the configuration refers to a single database type and host.
.PP
The script creates a hierarchy of lock files as it dumps each database.  One lockfile is for the script itself, one for each database configuration and one for each database dump.  This allows other programs to identify what backups are in progress and avoid conflicts.
.PP
The script was deliberately written using Perl modules available from a standard Perl install.  This was to make it more portable between hosting services.
.SS "The \fIdbbackup.conf\fP configuration file"
.IX Subsection "The dbbackup.conf configuration file"
\fIFile Format\fR
.IX Subsection "File Format"
.IP "\fI#\fR to the end of line" 4
.IX Item "# to the end of line"
Are comments.  These are stripped and never processed.
.IP "Blank lines" 4
.IX Item "Blank lines"
Are ignored.
.ie n .IP """${foo}"" or ""$foo\eW""" 4
.el .IP "\f(CW${foo}\fR or \f(CW$foo\eW\fR" 4
.IX Item "${foo} or $fooW"
Variables.  The value if taken from the key \f(CW\*(C`foo\*(C'\fR in the current section, the default section or environment variable of the same name in that order. If no
value is found the empty string is substituted.
.IP "key1=value1" 4
.IX Item "key1=value1"
key1 with value1 in the current section.  By default values are scalars.
.IP "key1=value2" 4
.IX Item "key1=value2"
A key repeated in a section turns the values into a list.
.IP "identifier" 4
.IX Item "identifier"
An identifier (no equals sign) starts a new section.  key=value pairs before the first section header go into the #default section.
.ie n .IP "$confdir" 4
.el .IP "\f(CW$confdir\fR" 4
.IX Item "$confdir"
The key confdir is set to the directory this configuration file is found in.  It can therefore be used as a variable in the configuration file.
.PP
\fIRecognized Key Values\fR
.IX Subsection "Recognized Key Values"
.IP "choice=string" 4
.IX Item "choice=string"
.PD 0
.IP "root=$HOME/tmp/backup" 4
.IX Item "root=$HOME/tmp/backup"
.PD
Common root for the backup tree \- where logs, output etc should go.
.IP "lockdir=$root/lock" 4
.IX Item "lockdir=$root/lock"
Directory lock files will be created.
.IP "logdir=$root/log" 4
.IX Item "logdir=$root/log"
Directory logfiles will be created.
.IP "dumpdir=$root/dump" 4
.IX Item "dumpdir=$root/dump"
Directory database dumps will be created.
.IP "db=mysql|psql" 4
.IX Item "db=mysql|psql"
Identify the type of database a section refers to.
.IP "ignore=true|false" 4
.IX Item "ignore=true|false"
.PD 0
.IP "host=mysql.example.com" 4
.IX Item "host=mysql.example.com"
.PD
The database host to talk to.
.IP "port=port number" 4
.IX Item "port=port number"
The port to talk to on the specified host.  The default
port is assumed if non is given.
.IP "user=superduperuser" 4
.IX Item "user=superduperuser"
A database user (role) with necessary backup privileges.
.IP "password=supersecretpassword \fB[db=mysql only]\fR" 4
.IX Item "password=supersecretpassword [db=mysql only]"
The users password.
.IP "dbname=database1" 4
.IX Item "dbname=database1"
Specific databases to be backed up.  If non are given the
database is queried for a list and all are backed up.
.Sp
Specify multiple times to specify a list of database names.
.IP "pgpassfile=$confdir/pgpass  \fB[db=psql only]\fR" 4
.IX Item "pgpassfile=$confdir/pgpass [db=psql only]"
A suitable postgres pgpass file.
.PP
\fINotes\fR
.IX Subsection "Notes"
.PP
\&\fBYes\fR you could make this recurse and break things, but then you get to keep all of the pieces.
.PP
Variable substitution is performed on the \fI#default\fR. section first and then the other sections in alphabetical order.
.PP
\&\fBNo\fR you cannot create identifiers starting with a #.  They would be stripped out as comments.  That is why such keys are used for internal purposes.
.SS "Mysql Specifics"
.IX Subsection "Mysql Specifics"
Mysql needs a username and password which must be given in the dbbackup.conf file.
Please make sure the dbbackup.conf file has minimal permissions.
.SS "Postgres Specifics"
.IX Subsection "Postgres Specifics"
Postgres does not accept passwords on the command line.  These must be
provided in a separate, correctly permissioned \fIpgpass\fR file.  By
default this file is looked for in the same directory as the dbbackup.conf
file.
.SH "SECURITY"
.IX Header "SECURITY"
Mysql needs a username and password to be given in the dbbackup.conf file. Please make sure the dbbackup.conf file has minimal permissions.
.PP
\&\fBdbdump\fR creates files with predictable names.  If it is run with elevated privileges then this is a security hole.  You must protect
against this by limiting the privileges of the directories where output (lock files, logs and backups) are created.
